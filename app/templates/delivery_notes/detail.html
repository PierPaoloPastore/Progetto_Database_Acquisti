{% extends "base.html" %}

{% block title %}DDT #{{ note.id }} - Dettaglio{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-0"><i class="bi bi-truck"></i> DDT #{{ note.id }}</h1>
            <small class="text-muted">Numero {{ note.ddt_number }} · {{ note.ddt_date.strftime('%d/%m/%Y') if note.ddt_date else '-' }}</small>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{{ url_for('delivery_notes.list_view') }}">← Torna all'elenco</a>
            {% if note.file_path %}
                <a class="btn btn-outline-primary" href="{{ url_for('delivery_notes.file_view', delivery_note_id=note.id) }}" target="_blank">
                    <i class="bi bi-file-earmark-pdf"></i> Apri PDF
                </a>
            {% endif %}
            <a class="btn btn-outline-success" href="{{ url_for('delivery_notes.match_document_view', delivery_note_id=note.id) }}">
                <i class="bi bi-link-45deg"></i> Abbina fattura
            </a>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Informazioni DDT</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-5 text-muted">Numero</dt>
                        <dd class="col-7">{{ note.ddt_number }}</dd>
                        <dt class="col-5 text-muted">Data</dt>
                        <dd class="col-7">{{ note.ddt_date.strftime('%d/%m/%Y') if note.ddt_date else '-' }}</dd>
                        <dt class="col-5 text-muted">Fornitore</dt>
                        <dd class="col-7">{{ note.supplier.name if note.supplier else 'N/D' }}</dd>
                        <dt class="col-5 text-muted">Intestatario</dt>
                        <dd class="col-7">{{ note.legal_entity.name if note.legal_entity else '-' }}</dd>
                        <dt class="col-5 text-muted">Totale</dt>
                        <dd class="col-7">{{ (note.total_amount or 0)|format_amount }} €</dd>
                        <dt class="col-5 text-muted">Stato</dt>
                        <dd class="col-7"><span class="badge bg-secondary text-uppercase">{{ note.status }}</span></dd>
                        <dt class="col-5 text-muted">Origine</dt>
                        <dd class="col-7">{{ note.source }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Righe DDT</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-line-btn">
                        <i class="bi bi-plus"></i> Aggiungi riga
                    </button>
                </div>
                <form method="POST">
                    <div class="card-body p-0">
                        <div class="table-responsive scrollable-list">
                            <table class="table table-hover table-striped mb-0 align-middle" id="lines-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 80px;">#</th>
                                        <th>Descrizione</th>
                                        <th style="width: 120px;">Codice</th>
                                        <th style="width: 110px;" class="text-end">Q.tà</th>
                                        <th style="width: 90px;">U.M.</th>
                                        <th style="width: 120px;" class="text-end">Importo</th>
                                        <th style="width: 80px;" class="text-end">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in note.delivery_note_lines %}
                                    <tr>
                                        <td>
                                            <input type="hidden" name="line_id" value="{{ line.id }}">
                                            <input type="number" name="line_number" class="form-control form-control-sm" value="{{ line.line_number }}" required>
                                        </td>
                                        <td>
                                            <input type="text" name="description" class="form-control form-control-sm" value="{{ line.description }}" required>
                                            <input type="text" name="notes" class="form-control form-control-sm mt-1" placeholder="Note" value="{{ line.notes or '' }}">
                                        </td>
                                        <td><input type="text" name="item_code" class="form-control form-control-sm" value="{{ line.item_code or '' }}"></td>
                                        <td><input type="number" step="0.0001" name="quantity" class="form-control form-control-sm text-end" value="{{ line.quantity }}"></td>
                                        <td><input type="text" name="uom" class="form-control form-control-sm" value="{{ line.uom or '' }}"></td>
                                        <td><input type="number" step="0.01" name="amount" class="form-control form-control-sm text-end" value="{{ line.amount }}"></td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr class="empty-placeholder">
                                        <td colspan="7" class="text-center text-muted py-4">
                                            Nessuna riga presente. Aggiungi una riga per descrivere la consegna.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white d-flex justify-content-end">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-save"></i> Salva righe
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const tableBody = document.querySelector("#lines-table tbody");
    const addBtn = document.getElementById("add-line-btn");

    const removeEmptyPlaceholder = () => {
        const placeholder = tableBody.querySelector(".empty-placeholder");
        if (placeholder) placeholder.remove();
    };

    const addRow = () => {
        removeEmptyPlaceholder();
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>
                <input type="hidden" name="line_id" value="">
                <input type="number" name="line_number" class="form-control form-control-sm" value="${tableBody.children.length + 1}" required>
            </td>
            <td>
                <input type="text" name="description" class="form-control form-control-sm" required>
                <input type="text" name="notes" class="form-control form-control-sm mt-1" placeholder="Note">
            </td>
            <td><input type="text" name="item_code" class="form-control form-control-sm"></td>
            <td><input type="number" step="0.0001" name="quantity" class="form-control form-control-sm text-end"></td>
            <td><input type="text" name="uom" class="form-control form-control-sm"></td>
            <td><input type="number" step="0.01" name="amount" class="form-control form-control-sm text-end"></td>
            <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">
                    <i class="bi bi-x-lg"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(tr);
    };

    addBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        addRow();
    });

    tableBody?.addEventListener("click", (e) => {
        if (e.target.closest(".remove-line-btn")) {
            const tr = e.target.closest("tr");
            tr.remove();
            if (!tableBody.children.length) {
                const empty = document.createElement("tr");
                empty.classList.add("empty-placeholder");
                empty.innerHTML = `<td colspan="7" class="text-center text-muted py-4">
                    Nessuna riga presente. Aggiungi una riga per descrivere la consegna.
                </td>`;
                tableBody.appendChild(empty);
            }
        }
    });
});
</script>
{% endblock %}
