{% extends "base.html" %}

{% block title %}Fattura #{{ invoice.id }} - Gestionale Acquisti{% endblock %}

{% block content %}
<h1>Dettaglio fattura #{{ invoice.id }}</h1>

<section class="panel">
    <h2>Dati fattura</h2>
    <div class="two-columns">
        <div>
            <p><strong>Numero:</strong> {{ invoice.invoice_number }}</p>
            <p><strong>Data fattura:</strong>
                {{ invoice.invoice_date.strftime('%d/%m/%Y') if invoice.invoice_date }}</p>
            <p><strong>Data registrazione:</strong>
                {{ invoice.registration_date.strftime('%d/%m/%Y') if invoice.registration_date }}</p>
            <p><strong>Intestatario:</strong>
                {% if invoice.legal_entity %}
                  {{ invoice.legal_entity.name }} - {{ invoice.legal_entity.vat_number }}
                {% else %}
                  -
                {% endif %}
            </p>
            <p><strong>Anno contabile:</strong> {{ invoice.accounting_year or '-' }}</p>
            <p><strong>File XML:</strong> {{ invoice.file_name }}</p>
        </div>
        <div>
            <p><strong>Totale imponibile:</strong>
                {{ "%.2f"|format(invoice.total_taxable_amount or 0) }} {{ invoice.currency }}</p>
            <p><strong>Totale IVA:</strong>
                {{ "%.2f"|format(invoice.total_vat_amount or 0) }} {{ invoice.currency }}</p>
            <p><strong>Totale lordo:</strong>
                {{ "%.2f"|format(invoice.total_gross_amount or 0) }} {{ invoice.currency }}</p>
            <p><strong>Scadenza principale:</strong>
                {{ invoice.due_date.strftime('%d/%m/%Y') if invoice.due_date }}</p>
        </div>
    </div>
</section>

<section class="panel">
    <h2>Fornitore</h2>
    {% if supplier %}
      <p><strong>Nome:</strong> {{ supplier.name }}</p>
      <p><strong>P.IVA:</strong> {{ supplier.vat_number }}</p>
      <p><strong>CF:</strong> {{ supplier.tax_code }}</p>
      <p><strong>Indirizzo:</strong>
          {{ supplier.address }},
          {{ supplier.postal_code }} {{ supplier.city }} ({{ supplier.province }})</p>
      <p><strong>PEC:</strong> {{ supplier.pec_email }}</p>
      <p><a href="{{ url_for('suppliers.detail_view', supplier_id=supplier.id) }}"
            class="btn-link">Vai al fornitore</a></p>
    {% else %}
      <p>Nessun fornitore collegato.</p>
    {% endif %}
</section>

<section class="panel">
    <h2>Stato documento</h2>
    <form method="post" action="{{ url_for('invoices.update_status_view', invoice_id=invoice.id) }}"
          class="form-inline" id="invoice-status-form">
        <div class="form-row">
            <label for="doc_status">Stato documento</label>
            <select id="doc_status" name="doc_status">
                {% for status in [
                    "imported",
                    "pending_physical_copy",
                    "verified",
                    "rejected",
                    "archived",
                ] %}
                  <option value="{{ status }}"
                    {% if invoice.doc_status == status %}selected{% endif %}>
                    {{ status }}
                  </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-row">
            <label for="payment_status">Stato pagamento</label>
            <select id="payment_status" name="payment_status">
                {% for status in ["unpaid", "partial", "paid"] %}
                  <option value="{{ status }}"
                    {% if invoice.payment_status == status %}selected{% endif %}>
                    {{ status }}
                  </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-row">
            <label for="due_date">Scadenza principale</label>
            <input type="date" id="due_date" name="due_date"
                   value="{{ invoice.due_date.strftime('%Y-%m-%d') if invoice.due_date }}">
        </div>

        <div class="form-actions">
            <button type="button" class="btn-secondary" data-doc-status="verified">
                Conferma
            </button>
            <button type="button" class="btn-secondary" data-doc-status="rejected">
                Scarta
            </button>
            <button type="submit" class="btn-primary">Aggiorna stato</button>
        </div>
    </form>
    {% if not invoice.physical_copy_file %}
        <a href="{{ url_for('invoices.attach_scan_view', invoice_id=invoice.id) }}"
           class="btn btn-secondary">
            Collega scansione
        </a>
    {% else %}
        <p><strong>Copia fisica:</strong> {{ invoice.physical_copy_file }}</p>
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('invoice-status-form');
            const docStatusSelect = document.getElementById('doc_status');
            const quickButtons = document.querySelectorAll('[data-doc-status]');

            quickButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    const targetStatus = this.dataset.docStatus;
                    if (targetStatus) {
                        docStatusSelect.value = targetStatus;
                        form.submit();
                    }
                });
            });
        });
    </script>
</section>

{% if invoice.doc_status in ["imported", "verified", "pending_physical_copy"] %}
<section class="panel">
    <h2>Copia fisica</h2>
    <p>
        {% set physical_status = invoice.physical_copy_status or 'missing' %}
        {% set badge_class = {
            'requested': 'badge-warning',
            'received': 'badge-success',
            'missing': 'badge-neutral'
        }.get(physical_status, 'badge-neutral') %}
        <strong>Stato copia cartacea:</strong>
        <span class="badge {{ badge_class }}">{{ physical_status }}</span>
    </p>
    <div class="form-actions">
        <form method="post"
              action="{{ url_for('invoices.request_physical_copy', invoice_id=invoice.id) }}">
            <button type="submit" class="btn-secondary">Invia richiesta al fornitore</button>
        </form>
        <form method="post"
              action="{{ url_for('invoices.mark_physical_copy_received', invoice_id=invoice.id) }}">
            <button type="submit" class="btn-primary">Segna copia ricevuta</button>
        </form>
    </div>
</section>
{% endif %}

<section class="panel">
    <h2>Righe fattura</h2>
    <p>
        <a href="{{ url_for('categories.bulk_assign_view', invoice_id=invoice.id) }}"
           class="btn-secondary">Assegna categorie (bulk)</a>
    </p>
    <div class="table-wrapper">
        <table class="table table-compact table-striped">
            <thead>
            <tr>
                <th>#</th>
                <th>Descrizione</th>
                <th>Q.t√†</th>
                <th>Prezzo unit.</th>
                <th>Aliquota IVA</th>
                <th>Totale riga</th>
                <th>Categoria</th>
            </tr>
            </thead>
            <tbody>
            {% for line in lines %}
              <tr>
                  <td>{{ line.line_number }}</td>
                  <td>{{ line.description }}</td>
                  <td class="text-right">{{ line.quantity }}</td>
                  <td class="text-right">{{ line.unit_price }}</td>
                  <td class="text-right">{{ line.vat_rate }}</td>
                  <td class="text-right">{{ line.total_line_amount }}</td>
                  <td>{{ line.category.name if line.category }}</td>
              </tr>
            {% else %}
              <tr>
                  <td colspan="7" class="text-center">Nessuna riga.</td>
              </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="panel two-columns-stack">
    <div>
        <h2>Riepilogo IVA</h2>
        <div class="table-wrapper">
            <table class="table table-compact">
                <thead>
                <tr>
                    <th>Aliquota</th>
                    <th>Imponibile</th>
                    <th>Imposta</th>
                    <th>Natura</th>
                </tr>
                </thead>
                <tbody>
                {% for vs in vat_summaries %}
                  <tr>
                      <td>{{ vs.vat_rate }}</td>
                      <td class="text-right">{{ vs.taxable_amount }}</td>
                      <td class="text-right">{{ vs.vat_amount }}</td>
                      <td>{{ vs.nature }}</td>
                  </tr>
                {% else %}
                  <tr>
                      <td colspan="4" class="text-center">Nessun riepilogo IVA.</td>
                  </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div>
        <h2>Pagamenti</h2>
        <div class="table-wrapper">
            <table class="table table-compact">
                <thead>
                <tr>
                    <th>Scadenza</th>
                    <th>Importo previsto</th>
                    <th>Data pagamento</th>
                    <th>Importo pagato</th>
                    <th>Metodo</th>
                    <th>Stato</th>
                </tr>
                </thead>
                <tbody>
                {% for p in payments %}
                  <tr>
                  <td>{{ p.due_date.strftime('%d/%m/%Y') if p.due_date }}</td>
                      <td class="text-right">{{ p.expected_amount }}</td>
                  <td>{{ p.paid_date.strftime('%d/%m/%Y') if p.paid_date }}</td>
                      <td class="text-right">{{ p.paid_amount }}</td>
                      <td>{{ p.payment_method }}</td>
                      <td>{{ p.status }}</td>
                  </tr>
                {% else %}
                  <tr>
                      <td colspan="6" class="text-center">Nessun pagamento registrato.</td>
                  </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="panel">
    <h2>Note</h2>
    {% if notes %}
      <ul class="list-simple">
      {% for note in notes %}
        <li>
            <strong>{{ note.created_at.strftime('%d/%m/%Y %H:%M') if note.created_at }}</strong> - {{ note.content }}
        </li>
      {% endfor %}
      </ul>
    {% else %}
      <p>Nessuna nota presente.</p>
    {% endif %}
</section>

{% endblock %}
