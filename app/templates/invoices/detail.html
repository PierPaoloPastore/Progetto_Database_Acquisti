{% extends "base.html" %}

{% block title %}Fattura #{{ invoice.id }} - Gestionale Acquisti{% endblock %}

{% block content %}
<h1>Dettaglio fattura #{{ invoice.id }}</h1>

{% if invoice.doc_status == 'imported' %}
<section class="panel">
    <h2>Revisione fattura importata</h2>
    <p>Conferma o scarta rapidamente la fattura importata.</p>
    <div class="form-actions">
        <form method="post" class="form-inline"
              action="{{ url_for('invoices.confirm_invoice', invoice_id=invoice.id, order=request.args.get('order', 'desc')) }}">
            <button type="submit" class="btn-primary">Conferma fattura</button>
        </form>
        <form method="post" class="form-inline"
              action="{{ url_for('invoices.reject_invoice', invoice_id=invoice.id, order=request.args.get('order', 'desc')) }}"
              onsubmit="return confirm('Sei sicuro di scartare questa fattura?');">
            <button type="submit" class="btn-secondary">Scarta fattura</button>
        </form>
    </div>
</section>
{% endif %}

<section class="panel">
    <h2>Dati fattura</h2>
    <div class="two-columns">
        <div>
            <p><strong>Numero:</strong> {{ invoice.document_number }}</p>
            <p><strong>Data fattura:</strong>
                {{ invoice.document_date.strftime('%d/%m/%Y') if invoice.document_date }}</p>
            <p><strong>Data registrazione:</strong>
                {{ invoice.registration_date.strftime('%d/%m/%Y') if invoice.registration_date }}</p>
            <p><strong>Intestatario:</strong>
                {% if invoice.legal_entity %}
                  {{ invoice.legal_entity.name }} - {{ invoice.legal_entity.vat_number }}
                {% else %}
                  -
                {% endif %}
            </p>
            <p><strong>Anno contabile:</strong> {{ invoice.document_date.year if invoice.document_date else '-' }}</p>
            <p><strong>File XML:</strong> {{ invoice.file_name }}</p>
        </div>
        <div>
            <p><strong>Totale imponibile:</strong>
                {{ "%.2f"|format(invoice.total_taxable_amount or 0) }} EUR</p>
            <p><strong>Totale IVA:</strong>
                {{ "%.2f"|format(invoice.total_vat_amount or 0) }} EUR</p>
            <p><strong>Totale lordo:</strong>
                {{ "%.2f"|format(invoice.total_gross_amount or 0) }} EUR</p>
            <p><strong>Scadenza principale:</strong>
                {{ invoice.due_date.strftime('%d/%m/%Y') if invoice.due_date }}</p>
        </div>
    </div>
</section>

<section class="panel">
    <h2>Fornitore</h2>
    {% if supplier %}
      <p><strong>Nome:</strong> {{ supplier.name }}</p>
      <p><strong>P.IVA:</strong> {{ supplier.vat_number }}</p>
      <p><strong>CF:</strong> {{ supplier.fiscal_code }}</p>
      <p><strong>Indirizzo:</strong>
          {{ supplier.address }},
          {{ supplier.postal_code }} {{ supplier.city }} ({{ supplier.province }})</p>
      <p><strong>PEC:</strong> {{ supplier.pec_email }}</p>
      <p><a href="{{ url_for('suppliers.detail_view', supplier_id=supplier.id) }}"
            class="btn-link">Vai al fornitore</a></p>
    {% else %}
      <p>Nessun fornitore collegato.</p>
    {% endif %}
</section>

<section class="panel">
    <h2>Stato documento</h2>
    <form method="post" action="{{ url_for('invoices.update_status_view', invoice_id=invoice.id) }}"
          class="form-inline" id="invoice-status-form">
        <div class="form-row">
            <label for="doc_status">Stato documento</label>
            <select id="doc_status" name="doc_status">
                {% for status in [
                    "imported",
                    "pending_physical_copy",
                    "verified",
                    "rejected",
                    "archived",
                ] %}
                  <option value="{{ status }}"
                    {% if invoice.doc_status == status %}selected{% endif %}>
                    {{ status }}
                  </option>
                {% endfor %}
            </select>
        </div>
        <!-- payment_status è deprecato in v3: lo stato pagamento si deduce dai Payment associati -->
        <div class="form-row">
            <label for="due_date">Scadenza principale</label>
            <input type="date" id="due_date" name="due_date"
                   value="{{ invoice.due_date.strftime('%Y-%m-%d') if invoice.due_date }}">
        </div>

        <div class="form-actions">
            <button type="button" class="btn-secondary" data-doc-status="verified">
                Conferma
            </button>
            <button type="button" class="btn-secondary" data-doc-status="rejected">
                Scarta
            </button>
            <button type="submit" class="btn-primary">Aggiorna stato</button>
            {% if not invoice.physical_copy_file_path %}
                <a href="{{ url_for('invoices.attach_scan_view', invoice_id=invoice.id) }}"
                   class="btn btn-primary">
                    Collega scansione
                </a>
            {% endif %}
        </div>
    </form>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('invoice-status-form');
            const docStatusSelect = document.getElementById('doc_status');
            const quickButtons = document.querySelectorAll('[data-doc-status]');

            quickButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    const targetStatus = this.dataset.docStatus;
                    if (targetStatus) {
                        docStatusSelect.value = targetStatus;
                        form.submit();
                    }
                });
            });
        });
    </script>
</section>

<section class="panel">
    <h2>Copia fisica</h2>
    {% set physical_status = invoice.physical_copy_status or 'missing' %}
    {% set badge_class = {
        'missing': 'status-badge status-missing',
        'requested': 'status-badge status-requested',
        'received': 'status-badge status-received'
    }.get(physical_status, 'status-badge') %}
    <div class="form-row">
        <strong>Stato copia:</strong>
        <span class="{{ badge_class }}">
            <span class="status-dot"></span>
            <span class="status-label">
                {% if physical_status == 'requested' %}
                    Richiesta
                {% elif physical_status == 'received' %}
                    Ricevuta
                {% else %}
                    Mancante
                {% endif %}
            </span>
        </span>
    </div>
    <div class="form-row">
        {% if invoice.physical_copy_requested_at %}
            <div>Richiesta il: {{ invoice.physical_copy_requested_at }}</div>
        {% endif %}
        {% if invoice.physical_copy_received_at %}
            <div>Ricevuta il: {{ invoice.physical_copy_received_at }}</div>
        {% endif %}
        {% if invoice.physical_copy_file_path %}
            <div>Percorso file: {{ invoice.physical_copy_file_path }}</div>
        {% endif %}
    </div>
    <div class="form-actions">
        {% if physical_status in ['missing'] %}
            <form method="post"
                  action="{{ url_for('invoices.request_physical_copy', invoice_id=invoice.id) }}">
                <button type="submit" class="btn-secondary">Richiedi copia fisica</button>
            </form>
        {% endif %}
        {% if physical_status in ['missing', 'requested'] %}
            <form method="post"
                  action="{{ url_for('invoices.mark_physical_copy_received', invoice_id=invoice.id) }}"
                  onsubmit="return confirm('Confermi la ricezione della copia fisica?');">
                <button type="submit" class="btn-primary">Segna copia ricevuta</button>
            </form>
        {% endif %}
    </div>
    {% if physical_status != 'received' %}
        <form method="post" enctype="multipart/form-data"
              action="{{ url_for('invoices.upload_physical_copy', invoice_id=invoice.id) }}"
              class="form-inline">
            <div class="form-row">
                <label for="physical_copy_file">Carica scansione</label>
                <input type="file" id="physical_copy_file" name="file" required>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn-primary">Carica scansione</button>
            </div>
        </form>
    {% endif %}
</section>

<section class="panel">
    <h2>Righe fattura</h2>
    <p>
        <a href="{{ url_for('categories.bulk_assign_view', invoice_id=invoice.id) }}"
           class="btn-secondary">Assegna categorie (bulk)</a>
    </p>
    <div class="table-wrapper">
        <table class="table table-compact table-striped">
            <thead>
            <tr>
                <th>#</th>
                <th>Descrizione</th>
                <th>Q.tà</th>
                <th>Prezzo unit.</th>
                <th>Aliquota IVA</th>
                <th>Totale riga</th>
                <th>Categoria</th>
            </tr>
            </thead>
            <tbody>
            {% for line in lines %}
              <tr>
                  <td>{{ line.line_number }}</td>
                  <td>{{ line.description }}</td>
                  <td class="text-right">{{ line.quantity }}</td>
                  <td class="text-right">{{ line.unit_price }}</td>
                  <td class="text-right">{{ line.vat_rate }}</td>
                  <td class="text-right">{{ line.total_line_amount }}</td>
                  <td>{{ line.category.name if line.category }}</td>
              </tr>
            {% else %}
              <tr>
                  <td colspan="7" class="text-center">Nessuna riga.</td>
              </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="panel two-columns-stack">
    <div>
        <h2>Riepilogo IVA</h2>
        <div class="table-wrapper">
            <table class="table table-compact">
                <thead>
                <tr>
                    <th>Aliquota</th>
                    <th>Imponibile</th>
                    <th>Imposta</th>
                    <th>Natura</th>
                </tr>
                </thead>
                <tbody>
                {% for vs in vat_summaries %}
                  <tr>
                      <td>{{ vs.vat_rate }}</td>
                      <td class="text-right">{{ vs.taxable_amount }}</td>
                      <td class="text-right">{{ vs.vat_amount }}</td>
                      <td>{{ vs.nature }}</td>
                  </tr>
                {% else %}
                  <tr>
                      <td colspan="4" class="text-center">Nessun riepilogo IVA.</td>
                  </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div>
        <h2>Pagamenti</h2>
        <p>
            <a href="{{ url_for('payments.inbox_view') }}" class="btn-link">Vai all'inbox pagamenti</a>
        </p>
        <div class="table-wrapper">
            <table class="table table-compact">
                <thead>
                <tr>
                    <th>Scadenza</th>
                    <th>Importo previsto</th>
                    <th>Data pagamento</th>
                    <th>Importo pagato</th>
                    <th>Metodo</th>
                    <th>Stato</th>
                    <th>Documento</th>
                </tr>
                </thead>
                <tbody>
                {% for p in payments %}
                  <tr>
                  <td>{{ p.due_date.strftime('%d/%m/%Y') if p.due_date }}</td>
                      <td class="text-right">{{ p.expected_amount }}</td>
                  <td>{{ p.paid_date.strftime('%d/%m/%Y') if p.paid_date }}</td>
                      <td class="text-right">{{ p.paid_amount }}</td>
                      <td>{{ p.payment_method }}</td>
                      <td>{{ p.status }}</td>
                      <td>
                          {% if p.payment_document %}
                              <a href="{{ url_for('payments.review_payment', document_id=p.payment_document.id) }}" class="btn-link">Documento #{{ p.payment_document.id }}</a>
                          {% else %}
                              -
                          {% endif %}
                      </td>
                  </tr>
                {% else %}
                  <tr>
                      <td colspan="7" class="text-center">Nessun pagamento registrato.</td>
                  </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="panel">
    <h2>Note</h2>
    {% if notes %}
      <ul class="list-simple">
      {% for note in notes %}
        <li>
            <strong>{{ note.created_at.strftime('%d/%m/%Y %H:%M') if note.created_at }}</strong> - {{ note.content }}
        </li>
      {% endfor %}
      </ul>
    {% else %}
      <p>Nessuna nota presente.</p>
    {% endif %}
</section>

{% endblock %}
