{% extends "base.html" %}

{% block title %}Pagamenti | Split View{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/payments.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0"><i class="bi bi-cash-stack"></i> Pagamenti</h1>
    </div>

    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="#tab-new" data-tab-target="tab-new" role="tab">Nuovo Pagamento</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#tab-history" data-tab-target="tab-history" role="tab">Elenco Pagamenti</a>
        </li>
    </ul>

    <section id="tab-new" class="tab-section">
        <div class="split-container">
            <div class="split-section card">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">Registrazione Batch</h5>
                </div>
                <div class="card-body d-flex flex-column gap-3">
                    <form action="{{ url_for('payments.batch_payment') }}" method="POST" enctype="multipart/form-data" class="d-flex flex-column gap-3">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label for="pdf-file" class="form-label">Allega PDF di pagamento</label>
                                <input type="file" name="file" id="pdf-file" accept="application/pdf" class="form-control">
                                <div class="form-text">Il PDF verra visualizzato nell'anteprima a destra.</div>
                            </div>
                            <div class="col-lg-6">
                                <label for="payment_method" class="form-label">Metodo di pagamento</label>
                                <select class="form-select" name="method" id="payment_method">
                                    <option value="bonifico">Bonifico</option>
                                    <option value="assegno">Assegno</option>
                                    <option value="contanti">Contanti</option>
                                    <option value="altro">Altro</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="notes" class="form-label">Note</label>
                                <textarea class="form-control" name="notes" id="notes" rows="2" placeholder="Dettagli aggiuntivi"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">OCR (opzionale)</label>
                                <div class="d-flex align-items-center gap-2">
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        id="payment-ocr-btn"
                                        data-ocr-endpoint="{{ url_for('payments.ocr_view') }}"
                                        data-ocr-map-endpoint="{{ url_for('payments.ocr_map_view') }}"
                                    >
                                        Esegui OCR
                                    </button>
                                    <span id="payment-ocr-status" class="text-muted small"></span>
                                </div>
                                <textarea
                                    id="payment-ocr-output"
                                    class="form-control mt-2"
                                    rows="4"
                                    placeholder="Testo OCR..."
                                    readonly
                                ></textarea>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="d-flex flex-wrap gap-2 flex-grow-1">
                                <div class="input-group w-auto flex-grow-1" style="min-width: 280px;">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="search" id="invoice-search" class="form-control" placeholder="Filtra per fornitore o numero documento">
                                </div>
                                <div class="input-group date-filter">
                                    <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                    <input type="date" id="invoice-date" class="form-control" placeholder="Data scadenza">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check2-circle"></i> Registra Pagamento Multiplo
                            </button>
                        </div>

                        <div class="invoice-list scrollable-list flex-grow-1 h-100">
                            <div class="invoice-header">
                                <span class="invoice-col checkbox-col">
                                    <i class="bi bi-check2-square"></i>
                                </span>
                                <span class="invoice-col date-col">Scadenza</span>
                                <span class="invoice-col supplier-col">Fornitore</span>
                                <span class="invoice-col doc-col">Documento</span>
                                <span class="invoice-col due-col text-end">Dovuto</span>
                                <span class="invoice-col amount-col text-end">Importo pagato</span>
                            </div>
                            <div class="invoice-body">
                                {% for doc in all_unpaid_invoices %}
                                    <div class="invoice-row align-items-center" data-search="{{ doc.supplier.name }} {{ doc.document_number }}" data-date="{{ doc.due_date.strftime('%Y-%m-%d') if doc.due_date else '' }}">
                                        <div class="invoice-col checkbox-col">
                                            <input class="form-check-input" type="checkbox" name="payment_id" value="{{ doc.id }}" aria-label="Seleziona pagamento">
                                        </div>
                                        <div class="invoice-col date-col">
                                            {% if doc.due_date %}
                                                {{ doc.due_date.strftime('%d/%m/%Y') }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </div>
                                        <div class="invoice-col supplier-col">{{ doc.supplier.name }}</div>
                                        <div class="invoice-col doc-col">{{ doc.document_number }}</div>
                                        <div class="invoice-col due-col text-end">
                                            <small class="text-muted d-block">Importo dovuto</small>
                                            {% set paid_val = (doc.paid_amount if doc.paid_amount is defined else 0) %}
                                            {% set remaining_val = (doc.remaining_amount if doc.remaining_amount is defined else (doc.total_gross_amount - paid_val)) %}
                                            {% set due_val = remaining_val if remaining_val is not none else doc.total_gross_amount %}
                                            <strong>{{ "%.2f"|format(due_val) }} &euro;</strong>
                                        </div>
                                        <div class="invoice-col amount-col text-end">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">&euro;</span>
                                                <input type="number" step="0.01" min="0" class="form-control text-end" name="amount_{{ doc.id }}" placeholder="0,00">
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="invoice-empty text-center text-muted py-4">
                                        <i class="bi bi-inbox d-block fs-3 mb-2"></i>
                                        Nessuna fattura da pagare.
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="split-section card">
                <div class="card-header bg-white border-bottom-0 d-flex align-items-center">
                    <h5 class="mb-0">Anteprima PDF</h5>
                </div>
                <div class="card-body position-relative">
                    <!-- Placeholder (shown when no file selected) -->
                    <div id="pdf-placeholder" class="preview-placeholder">
                        <p class="text-center text-muted py-5">
                            <i class="bi bi-file-earmark-pdf fs-1"></i><br>
                            Carica un PDF per visualizzarlo qui.
                        </p>
                    </div>
                    <!-- Iframe (NO srcdoc attribute!) -->
                    <iframe id="pdf-preview" class="preview-frame" title="Anteprima PDF"></iframe>
                </div>
            </div>
        </div>
    </section>

    <section id="tab-history" class="tab-section d-none">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Elenco Pagamenti</h5>
                    <small class="text-muted">Movimenti registrati (stato partial / paid)</small>
                </div>
                <span class="badge bg-light text-dark">{{ payment_history|length }} movimenti</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive scrollable-list scrollable-list-flush">
                    <table class="table table-hover table-striped mb-0 align-middle sticky-header">
                        <thead class="table-light">
                            <tr>
                                <th>Data pagamento</th>
                                <th>Documento</th>
                                <th>Fornitore</th>
                                <th class="text-end">Importo pagato</th>
                                <th>Metodo</th>
                                <th>Stato</th>
                                <th class="text-end">Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payment_history %}
                                {% set invoice = payment.document %}
                                <tr>
                                    <td>{{ payment.paid_date.strftime('%d/%m/%Y') if payment.paid_date else (payment.updated_at.strftime('%d/%m/%Y') if payment.updated_at else '-') }}</td>
                                    <td>
                                        {% if invoice %}
                                            <div class="fw-bold">{{ invoice.document_number or ('Documento #' ~ invoice.id) }}</div>
                                            <small class="text-muted">ID {{ invoice.id }}</small>
                                            {% if payment.payment_document_id %}
                                                <div class="text-muted small">Batch #{{ payment.payment_document_id }}</div>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Documento non disponibile</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if invoice and invoice.supplier %}
                                            <a href="{{ url_for('suppliers.detail_view', supplier_id=invoice.supplier_id) }}" class="text-decoration-none fw-bold">
                                                {{ invoice.supplier.name }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ "%.2f"|format(payment.paid_amount or payment.expected_amount or 0) }} &euro;</td>
                                    <td>{{ payment.payment_method or (payment.payment_document.payment_type if payment.payment_document) or 'N/D' }}</td>
                                    <td>
                                        <span class="status-badge status-{{ payment.status }}">{{ payment.status }}</span>
                                    </td>
                                    <td class="text-end">
                                        <a href="{{ url_for('payments.payment_detail_view', payment_id=payment.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Dettaglio
                                        </a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-5 text-muted">
                                        <i class="bi bi-journal-check fs-1 d-block mb-3 text-success"></i>
                                        Nessun pagamento registrato finora.
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/payments.js') }}"></script>
{% endblock %}

