{% extends "base.html" %}

{% block title %}Revisione pagamento #{{ document.id }} - Gestionale Acquisti{% endblock %}

{% block content %}
<h1>Revisione pagamento</h1>

<div class="two-columns">
    <div>
        <h2>Documento</h2>
        <div class="panel">
            <embed src="{{ url_for('payments.serve_payment_file', document_id=document.id) }}" type="application/pdf" width="100%" height="800px">
        </div>
    </div>
    <div>
        <section class="panel">
            <h2>Dettagli documento</h2>
            <p><strong>Nome file:</strong> {{ document.file_name }}</p>
            <p><strong>Tipo:</strong> {{ document.payment_type }}</p>
            <p><strong>Stato:</strong> {{ document.status }}</p>
            <p><strong>Importo rilevato:</strong>
                {% if document.parsed_amount %}
                    {{ "%.2f"|format(document.parsed_amount) }}
                {% else %}-{% endif %}
            </p>
            <p><strong>Data pagamento rilevata:</strong>
                {{ document.parsed_payment_date.strftime('%d/%m/%Y') if document.parsed_payment_date else '-' }}</p>
            <p><strong>Numero fattura rilevato:</strong> {{ document.parsed_invoice_number or '-' }}</p>
        </section>

        <section class="panel">
            <h2>Collega alle fatture</h2>
            <form method="post" action="{{ url_for('payments.assign_payment', document_id=document.id) }}">
                <div class="table-wrapper">
                    <table class="table table-compact table-striped">
                        <thead>
                        <tr>
                            <th></th>
                            <th>Numero</th>
                            <th>Fornitore</th>
                            <th>Data</th>
                            <th>Totale</th>
                            <th>Importo pagato</th>
                            <th>Metodo</th>
                            <th>Note</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for invoice in candidate_invoices %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="invoice_id" value="{{ invoice.id }}">
                                </td>
                                <td>{{ invoice.invoice_number }}</td>
                                <td>{{ invoice.supplier.name if invoice.supplier else '-' }}</td>
                                <td>{{ invoice.document_date.strftime('%d/%m/%Y') if invoice.document_date }}</td>
                                <td class="text-right">{{ "%.2f"|format(invoice.total_gross_amount or 0) }}</td>
                                <td>
                                    <input type="number" step="0.01" name="amount_{{ invoice.id }}" placeholder="Importo">
                                    <div class="text-small">Stato: {{ invoice.payment_status }}</div>
                                </td>
                                <td>
                                    <input type="text" name="payment_method_{{ invoice.id }}" placeholder="Metodo" value="{{ document.payment_type }}">
                                </td>
                                <td>
                                    <input type="text" name="notes_{{ invoice.id }}" placeholder="Note">
                                    <input type="date" name="paid_date_{{ invoice.id }}" value="{{ document.parsed_payment_date.strftime('%Y-%m-%d') if document.parsed_payment_date }}">
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center">Nessuna fattura candidata.</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Conferma collegamenti</button>
                    <a href="{{ url_for('payments.inbox_view') }}" class="btn-secondary">Torna all'inbox</a>
                </div>
            </form>
        </section>
    </div>
</div>
{% endblock %}
