{% extends "base.html" %}

{% block title %}Fattura #{{ invoice.id }} - Gestionale Acquisti{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Fattura #{{ invoice.id }}</h1>
    <div class="page-actions">
        <a href="{{ url_for('documents.list_view') }}" class="btn-secondary">‚Üê Torna all'elenco</a>
    </div>
</div>

<!-- ALERT REVISIONE (se imported) -->
{% if invoice.doc_status == 'imported' %}
<div class="alert alert-warning">
    <strong>‚ö†Ô∏è Revisione richiesta</strong>
    <p>Questa fattura √® stata importata ma non ancora confermata.</p>
    <div class="alert-actions">
        <form method="post" style="display:inline;"
              action="{{ url_for('documents.confirm_invoice', document_id=invoice.id) }}">
            <button type="submit" class="btn-primary btn-sm">‚úì Conferma</button>
        </form>
        <form method="post" style="display:inline;"
              action="{{ url_for('documents.reject_invoice', document_id=invoice.id) }}"
              onsubmit="return confirm('Scartare questa fattura?');">
            <button type="submit" class="btn-secondary btn-sm">‚úó Scarta</button>
        </form>
    </div>
</div>
{% endif %}

<!-- GRID CARDS: Dati Principali -->
<div class="cards-grid cards-2col">
    <!-- CARD: Dati Documento -->
    <div class="card">
        <div class="card-header">
            <h3>üìÑ Dati Documento</h3>
        </div>
        <div class="card-body">
            <div class="data-row">
                <span class="label">Numero:</span>
                <span class="value">{{ invoice.document_number }}</span>
            </div>
            <div class="data-row">
                <span class="label">Data fattura:</span>
                <span class="value">{{ invoice.document_date.strftime('%d/%m/%Y') if invoice.document_date else '-' }}</span>
            </div>
            <div class="data-row">
                <span class="label">Registrazione:</span>
                <span class="value">{{ invoice.registration_date.strftime('%d/%m/%Y') if invoice.registration_date else '-' }}</span>
            </div>
            <div class="data-row">
                <span class="label">Scadenza:</span>
                <span class="value">{{ invoice.due_date.strftime('%d/%m/%Y') if invoice.due_date else '-' }}</span>
            </div>
            <div class="data-row">
                <span class="label">Anno contabile:</span>
                <span class="value">{{ invoice.document_date.year if invoice.document_date else '-' }}</span>
            </div>
            <div class="data-row">
                <span class="label">File XML:</span>
                <span class="value text-muted small">{{ invoice.file_name }}</span>
            </div>
        </div>
    </div>

    <!-- CARD: Totali -->
    <div class="card">
        <div class="card-header">
            <h3>üí∞ Importi</h3>
        </div>
        <div class="card-body">
            <div class="data-row">
                <span class="label">Imponibile:</span>
                <span class="value">‚Ç¨ {{ "%.2f"|format(invoice.total_taxable_amount or 0) }}</span>
            </div>
            <div class="data-row">
                <span class="label">IVA:</span>
                <span class="value">‚Ç¨ {{ "%.2f"|format(invoice.total_vat_amount or 0) }}</span>
            </div>
            <div class="data-row highlight">
                <span class="label">Totale lordo:</span>
                <span class="value text-bold text-large">‚Ç¨ {{ "%.2f"|format(invoice.total_gross_amount or 0) }}</span>
            </div>
        </div>
    </div>

    <!-- CARD: Fornitore -->
    <div class="card">
        <div class="card-header">
            <h3>üè¢ Fornitore</h3>
        </div>
        <div class="card-body">
            {% if supplier %}
            <div class="data-row">
                <span class="label">Nome:</span>
                <span class="value">{{ supplier.name }}</span>
            </div>
            <div class="data-row">
                <span class="label">P.IVA:</span>
                <span class="value">{{ supplier.vat_number }}</span>
            </div>
            <div class="data-row">
                <span class="label">CF:</span>
                <span class="value">{{ supplier.fiscal_code or '-' }}</span>
            </div>
            <div class="data-row">
                <span class="label">Indirizzo:</span>
                <span class="value">{{ supplier.address }}, {{ supplier.postal_code }} {{ supplier.city }} ({{ supplier.province }})</span>
            </div>
            <div class="data-row">
                <span class="label">PEC:</span>
                <span class="value">{{ supplier.pec_email or '-' }}</span>
            </div>
            <a href="{{ url_for('suppliers.detail_view', supplier_id=supplier.id) }}"
               class="btn-link btn-sm">‚Üí Vai al fornitore</a>
            {% else %}
            <p class="text-muted">Nessun fornitore collegato</p>
            {% endif %}
        </div>
    </div>

    <!-- CARD: Intestatario -->
    <div class="card">
        <div class="card-header">
            <h3>üèõÔ∏è Intestatario</h3>
        </div>
        <div class="card-body">
            {% if invoice.legal_entity %}
            <div class="data-row">
                <span class="label">Nome:</span>
                <span class="value">{{ invoice.legal_entity.name }}</span>
            </div>
            <div class="data-row">
                <span class="label">P.IVA:</span>
                <span class="value">{{ invoice.legal_entity.vat_number }}</span>
            </div>
            <div class="data-row">
                <span class="label">CF:</span>
                <span class="value">{{ invoice.legal_entity.fiscal_code or '-' }}</span>
            </div>
            {% else %}
            <p class="text-muted">Nessun intestatario</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- GRID CARDS: Stato + Copia Fisica -->
<div class="cards-grid cards-2col">
    <!-- CARD: Stato Documento -->
    <div class="card">
        <div class="card-header">
            <h3>üìã Stato Documento</h3>
        </div>
        <div class="card-body">
            <form method="post" action="{{ url_for('documents.update_status_view', document_id=invoice.id) }}"
                  id="invoice-status-form">
                <div class="form-group">
                    <label for="doc_status">Stato</label>
                    <select id="doc_status" name="doc_status" class="form-control">
                        <option value="imported"{% if invoice.doc_status == 'imported' %} selected{% endif %}>Importata</option>
                        <option value="pending_physical_copy"{% if invoice.doc_status == 'pending_physical_copy' %} selected{% endif %}>In attesa copia</option>
                        <option value="verified"{% if invoice.doc_status == 'verified' %} selected{% endif %}>Verificata</option>
                        <option value="rejected"{% if invoice.doc_status == 'rejected' %} selected{% endif %}>Scartata</option>
                        <option value="archived"{% if invoice.doc_status == 'archived' %} selected{% endif %}>Archiviata</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="due_date">Scadenza principale</label>
                    <input type="date" id="due_date" name="due_date" class="form-control"
                           value="{{ invoice.due_date.strftime('%Y-%m-%d') if invoice.due_date }}">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Aggiorna</button>
                    {% if not invoice.physical_copy_file_path %}
                        <a href="{{ url_for('documents.attach_scan_view', document_id=invoice.id) }}"
                           class="btn-secondary btn-sm">Collega scansione</a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- CARD: Copia Fisica -->
    <div class="card">
        <div class="card-header">
            <h3>üìé Copia Fisica</h3>
        </div>
        <div class="card-body">
            {% set physical_status = invoice.physical_copy_status or 'missing' %}
            <div class="data-row">
                <span class="label">Stato:</span>
                <span class="status-badge status-{{ physical_status }}">
                    <span class="status-dot"></span>
                    {{ physical_status }}
                </span>
            </div>
            {% if invoice.physical_copy_requested_at %}
            <div class="data-row">
                <span class="label">Richiesta il:</span>
                <span class="value">{{ invoice.physical_copy_requested_at.strftime('%d/%m/%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if invoice.physical_copy_received_at %}
            <div class="data-row">
                <span class="label">Ricevuta il:</span>
                <span class="value">{{ invoice.physical_copy_received_at.strftime('%d/%m/%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if invoice.physical_copy_file_path %}
            <div class="data-row">
                <span class="label">File:</span>
                <span class="value text-muted small">{{ invoice.physical_copy_file_path }}</span>
            </div>
            {% endif %}

            <div class="form-actions">
                {% if physical_status == 'missing' %}
                    <form method="post" action="{{ url_for('documents.request_physical_copy', document_id=invoice.id) }}">
                        <button type="submit" class="btn-secondary btn-sm">Richiedi copia</button>
                    </form>
                {% endif %}
                {% if physical_status in ['missing', 'requested'] %}
                    <form method="post"
                          action="{{ url_for('documents.mark_physical_copy_received', document_id=invoice.id) }}"
                          onsubmit="return confirm('Confermi ricezione copia fisica?');">
                        <button type="submit" class="btn-primary btn-sm">Segna ricevuta</button>
                    </form>
                {% endif %}
            </div>

            {% if physical_status != 'received' %}
            <form method="post" enctype="multipart/form-data"
                  action="{{ url_for('documents.upload_physical_copy', document_id=invoice.id) }}"
                  class="upload-form">
                <div class="form-group">
                    <label for="physical_copy_file">Carica scansione</label>
                    <input type="file" id="physical_copy_file" name="file" class="form-control" required>
                </div>
                <button type="submit" class="btn-primary btn-sm">Upload</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<!-- SEZIONE: Righe Fattura -->
<section class="panel">
    <div class="panel-header">
        <h2>üì¶ Righe Fattura</h2>
        <a href="{{ url_for('categories.bulk_assign_view', document_id=invoice.id) }}"
           class="btn-secondary btn-sm">Assegna categorie</a>
    </div>
    <div class="table-wrapper">
        <table class="table-compact">
            <thead>
            <tr>
                <th>#</th>
                <th>Descrizione</th>
                <th class="text-right">Q.t√†</th>
                <th class="text-right">Prezzo</th>
                <th class="text-right">IVA</th>
                <th class="text-right">Totale</th>
                <th>Categoria</th>
            </tr>
            </thead>
            <tbody>
            {% for line in lines %}
              <tr>
                  <td>{{ line.line_number }}</td>
                  <td class="text-truncate" title="{{ line.description }}">{{ line.description }}</td>
                  <td class="text-right">{{ line.quantity }}</td>
                  <td class="text-right">{{ line.unit_price }}</td>
                  <td class="text-right">{{ line.vat_rate }}%</td>
                  <td class="text-right text-bold">‚Ç¨ {{ line.total_line_amount }}</td>
                  <td>{{ line.category.name if line.category else '-' }}</td>
              </tr>
            {% else %}
              <tr>
                  <td colspan="7" class="text-center text-muted">Nessuna riga</td>
              </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- GRID: Riepilogo IVA + Pagamenti -->
<div class="cards-grid cards-2col">
    <!-- CARD: Riepilogo IVA -->
    <div class="card">
        <div class="card-header">
            <h3>üìä Riepilogo IVA</h3>
        </div>
        <div class="card-body">
            <table class="table-compact">
                <thead>
                <tr>
                    <th>Aliquota</th>
                    <th class="text-right">Imponibile</th>
                    <th class="text-right">Imposta</th>
                    <th>Natura</th>
                </tr>
                </thead>
                <tbody>
                {% for vs in vat_summaries %}
                  <tr>
                      <td>{{ vs.vat_rate }}%</td>
                      <td class="text-right">‚Ç¨ {{ vs.taxable_amount }}</td>
                      <td class="text-right">‚Ç¨ {{ vs.vat_amount }}</td>
                      <td>{{ vs.vat_nature or '-' }}</td>
                  </tr>
                {% else %}
                  <tr>
                      <td colspan="4" class="text-center text-muted">Nessun riepilogo</td>
                  </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- CARD: Pagamenti -->
    <div class="card">
        <div class="card-header">
            <h3>üí≥ Pagamenti</h3>
            <a href="{{ url_for('payments.inbox_view') }}" class="btn-link btn-sm">Inbox pagamenti ‚Üí</a>
        </div>
        <div class="card-body">
            <table class="table-compact">
                <thead>
                <tr>
                    <th>Scadenza</th>
                    <th class="text-right">Previsto</th>
                    <th class="text-right">Pagato</th>
                    <th>Stato</th>
                </tr>
                </thead>
                <tbody>
                {% for p in payments %}
                  <tr>
                      <td>{{ p.due_date.strftime('%d/%m/%Y') if p.due_date else '-' }}</td>
                      <td class="text-right">‚Ç¨ {{ p.expected_amount }}</td>
                      <td class="text-right">‚Ç¨ {{ p.paid_amount or 0 }}</td>
                      <td>
                          <span class="status-badge status-{{ p.status }}">{{ p.status }}</span>
                      </td>
                  </tr>
                {% else %}
                  <tr>
                      <td colspan="4" class="text-center text-muted">Nessun pagamento</td>
                  </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- SEZIONE: Note -->
<section class="panel">
    <div class="panel-header">
        <h2>üìù Note</h2>
    </div>
    {% if notes %}
      <ul class="notes-list">
      {% for note in notes %}
        <li class="note-item">
            <span class="note-date">{{ note.created_at.strftime('%d/%m/%Y %H:%M') if note.created_at }}</span>
            <span class="note-content">{{ note.content }}</span>
        </li>
      {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">Nessuna nota presente.</p>
    {% endif %}
</section>

{% endblock %}